# Stellar Flare Detection Using Harmonic Detrending and Statistical Testing

This repository contains Python code for detecting stellar flares in TESS (Transiting Exoplanet Survey Satellite) light curve data using harmonic detrending combined with advanced statistical methods.

## Overview

The analysis pipeline consists of two main components:

1. **Flare Detection** ([finally-Copy1.ipynb](finally-Copy1.ipynb)) - Implements the core flare detection algorithm
2. **Visualization** ([13955part1.ipynb](13955part1.ipynb)) - Generates publication-quality plots and figures

## Dependencies

The code requires the following Python packages:

```
pandas
numpy
matplotlib
scipy
lmfit
astropy
scikit-learn
statsmodels
arch
numba
```

Install all dependencies using:
```bash
pip install pandas numpy matplotlib scipy lmfit astropy scikit-learn statsmodels arch numba
```

## File Descriptions

### 1. finally-Copy1.ipynb - Flare Detection Method

This notebook implements the complete flare detection pipeline.

#### Key Components:

- **Harmonic Model**: Multi-layer harmonic function for modeling stellar variability
- **Outlier Detection**: Iterative MAD-based outlier identification
- **Time Series Analysis**: ARMA modeling for temporal correlations
- **Volatility Modeling**: GARCH models for heteroscedastic residuals
- **Statistical Testing**: Benjamini-Hochberg (FDR) and Holm-Bonferroni (FWER) procedures

#### Main Functions:

- `harmonic_func()`: Multi-layer harmonic model for periodic stellar variations
- `flare_detection_MAD()`: Main flare detection algorithm using harmonic detrending
- `flare_detection()`: Statistical significance testing with BH and HB procedures
- `MAD_1()` and `MAD_2()`: Robust scale estimators
- `pdcsap_flux_to_mjy()`: Converts TESS flux units to milliJanskys

#### Input Data:

The notebook expects TESS SPOC light curve FITS files:
- Path format: `TIC{TIC_ID}/hlsp_tess-spoc_tess_phot_{TIC_ID}-{sector}_tess_v1_tp/*.fits`
- Uses the `PDCSAP_FLUX` column from the FITS file

#### Output:

The notebook generates:
- `*_new_FLARE.txt`: Tab-delimited file containing:
  - `TIME`: Barycentric Julian Date
  - `PDCSAP_FLUX`: Original flux values
  - `PDCSAP_FLUX_ERR`: Flux uncertainties
  - `FLARE_HB`: Binary flag for Holm-Bonferroni detected flares
  - `FLARE_BH`: Binary flag for Benjamini-Hochberg detected flares
  - `FLARE_candidate`: Binary flag for candidate flares
  - `DE-HARMONIC`: De-trended residuals
  - `Zt`: ARMA residuals
  - `epsilont`: Standardized residuals
  - `pp`: p-values
- `*_global.txt`: Global parameters (tsig, GARCH orders, p-value thresholds)
- `*_params_part1.txt` and `*_params_part2.txt`: Fitted harmonic model parameters with bootstrap standard errors

#### Usage:

1. Set the `file_path` variable to your TESS light curve FITS file
2. Adjust parameters as needed:
   - `layer`: Number of harmonic layers (default: 20)
   - `alpha`: Significance level (default: 0.99 for MAD detection, 0.05 for final testing)
   - `n`: Maximum iterations for harmonic fitting (default: 3-5)
   - `N`: Minimum window size for scale estimation (default: 100)
3. Run all cells sequentially
4. Output files will be saved in the same directory as the input FITS file

### 2. 13955part1.ipynb - Plotting and Visualization

This notebook generates publication-quality figures from the flare detection results.

#### Generated Plots:

1. **Light Curve Plot**: Original PDCSAP flux with error bars and median flux line
2. **Harmonic Fit Plot**: Original data overlaid with best-fit harmonic model
3. **De-harmonic Residuals**: Two-panel plot showing:
   - Top: Original flux with harmonic fit
   - Bottom: Residuals after harmonic removal
4. **Flare Analysis**: Residuals and standardized residuals with detected flares marked
5. **p-value Threshold Plot**: Ranked p-values with BH and HB decision thresholds
6. **Distribution Plot**: Histogram of standardized residuals with fitted Gaussian and detection thresholds

#### Input:

Reads the `*_new_FLARE.txt` file generated by the flare detection notebook.

#### Usage:

1. Set the `file_path` variable to point to your `*_new_FLARE.txt` file
2. Run all cells to generate plots
3. Plots are automatically saved as PDF files with descriptive names

## Methodology

### Step 1: Harmonic Detrending

The code fits a multi-layer harmonic model to capture stellar variability:

```
y(t) = γ₀β₀ + β₀sin(2πt/m + φ₀) + Σᵢ[γ₀γᵢ + γᵢsin(2πit/m + φᵢ)]sin(2πit/m + ηᵢ)
```

Outliers are iteratively identified and removed using MAD-based statistics.

### Step 2: ARMA Modeling

Temporal correlations in the residuals are modeled using ARMA(p,q) models selected by BIC.

### Step 3: GARCH Modeling

Conditional heteroscedasticity is captured using GARCH(p,q) models to obtain standardized residuals.

### Step 4: Statistical Testing

Flare candidates are identified where standardized residuals exceed empirical quantiles. Final detection uses:
- **Benjamini-Hochberg (BH)**: Controls False Discovery Rate
- **Holm-Bonferroni (HB)**: Controls Family-Wise Error Rate

## Example Workflow

```python
# 1. Run flare detection
# Open finally-Copy1.ipynb
# Set your FITS file path
file_path = 'path/to/your/hlsp_tess-spoc_*_lc.fits'
# Run all cells

# 2. Generate plots
# Open 13955part1.ipynb
# Set path to the generated FLARE.txt file
file_path = 'path/to/your/*_new_FLARE.txt'
# Run all cells to create publication plots
```

## Output Interpretation

### FLARE Flags:
- `FLARE_BH = 1`: Flare detected by Benjamini-Hochberg procedure (higher sensitivity)
- `FLARE_HB = 1`: Flare detected by Holm-Bonferroni procedure (higher specificity)
- `FLARE_candidate = 1`: Initial flare candidate before statistical testing

### Key Metrics:
- **tsig**: Robust scale estimate for standardized residuals
- **pBH**: Benjamini-Hochberg p-value threshold
- **pHB**: Holm-Bonferroni p-value threshold

## Citation

If you use this code in your research, please cite the associated paper [citation information to be added].

## Contact

For questions or issues, please open an issue on this GitHub repository.

## License

[Add your license information here]
